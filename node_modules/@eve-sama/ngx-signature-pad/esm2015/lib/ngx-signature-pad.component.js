import { Component, Renderer2, Input, Output, EventEmitter, ViewChild, ViewContainerRef } from '@angular/core';
import SignaturePad from 'signature_pad';
import { Overlay } from '@angular/cdk/overlay';
import { TemplatePortal } from '@angular/cdk/portal';
export class NgxSignaturePadComponent {
    constructor(renderer2, overlay, viewContainerRef) {
        this.renderer2 = renderer2;
        this.overlay = overlay;
        this.viewContainerRef = viewContainerRef;
        // #endregion
        this.signDataHistory = [];
        this._isEmpty = true;
        this.isFullScreen = false;
        this.options = {};
        this.beginSign = new EventEmitter();
        this.endSign = new EventEmitter();
    }
    get activePad() {
        return this.isFullScreen ? this.bigPad : this.smallPad;
    }
    fullScreen() {
        this.portal = new TemplatePortal(this.fullScreenTpl, this.viewContainerRef);
        this.overlayRef = this.overlay.create({
            positionStrategy: this.overlay.position().global(),
            scrollStrategy: this.overlay.scrollStrategies.block(),
            height: '100%',
            width: '100%'
        });
        this.overlayRef.attach(this.portal);
        this.initBigPad();
        // #region Copy miniScreen's content to fullScreen
        const { width: miniScreenWidth, height: miniScreenHeight } = this.options;
        const ctx = this.bigCanvas.getContext('2d');
        ctx.save();
        ctx.translate(this.fullScreenWidth, 0);
        ctx.rotate((90 * Math.PI) / 180);
        ctx.drawImage(this.smallCanvas, 0, 0, miniScreenWidth, miniScreenHeight, 0, 0, this.fullScreenHeight, this.fullScreenWidth);
        ctx.restore();
        // #endregion
        this.isFullScreen = true;
    }
    miniScreen() {
        this.smallPad.clear();
        // #region Copy fullScreen's content to miniScreen
        const { width: miniScreenWidth, height: miniScreenHeight } = this.options;
        const widthScale = miniScreenWidth / this.fullScreenHeight;
        const heightScale = miniScreenHeight / this.fullScreenWidth;
        const ctx = this.smallCanvas.getContext('2d');
        ctx.save();
        ctx.translate(0, miniScreenHeight);
        ctx.rotate((-90 * Math.PI) / 180);
        ctx.drawImage(this.bigCanvas, 0, 0, this.fullScreenWidth, this.fullScreenHeight, 0, 0, this.fullScreenWidth * widthScale, this.fullScreenHeight * heightScale);
        ctx.restore();
        // #endregion
        this.overlayRef.dispose();
        this.bigCanvas = null;
        this.bigPad = null;
        this.isFullScreen = false;
    }
    /** Returns signature image as an array of point groups */
    toData() {
        return this.activePad.toData();
    }
    /** Draws signature image from an array of point groups */
    fromData(pointGroups) {
        this.activePad.fromData(pointGroups);
    }
    toDataURL(type) {
        switch (type) {
            case 'image/jpeg':
                return this.activePad.toDataURL('image/jpeg');
            case 'image/svg+xml':
                return this.activePad.toDataURL('image/svg+xml');
            default:
                return this.activePad.toDataURL();
        }
    }
    revert() {
        this.signDataHistory.pop();
        this.fromData(this.signDataHistory);
        if (this.signDataHistory.length === 0) {
            this.setEmpty();
        }
    }
    // Clears the canvas
    clear() {
        this.setEmpty();
        this.signDataHistory = [];
        this.activePad.clear();
    }
    /** Return true if canvas is empty, otherwise return false */
    isEmpty() {
        return this._isEmpty;
    }
    /** Set canvas's state as dirty */
    setDirty() {
        this._isEmpty = false;
    }
    /** Set canvas's state as empty */
    setEmpty() {
        this._isEmpty = true;
    }
    getContext() {
        return this.isFullScreen ? this.bigCanvas.getContext('2d') : this.smallCanvas.getContext('2d');
    }
    initBigPad() {
        this.bigCanvas = document.querySelector('#nsp-big');
        const fullScreenOptions = JSON.parse(JSON.stringify(this.options));
        // Calculate the fullScreen pad's size
        this.fullScreenWidth = document.documentElement.clientWidth;
        const { width: miniScreenWidth, height: miniScreenHeight } = this.options;
        this.fullScreenHeight = (this.fullScreenWidth * miniScreenWidth) / miniScreenHeight;
        // Calculate section size
        const viewHeight = document.documentElement.clientHeight;
        const space = viewHeight - this.fullScreenHeight;
        this.sectionHeight = space / 2;
        // Init pad
        fullScreenOptions.width = this.fullScreenWidth;
        fullScreenOptions.height = this.fullScreenHeight;
        const { css } = fullScreenOptions;
        this.bigCanvas.width = this.fullScreenWidth;
        this.bigCanvas.height = this.fullScreenHeight;
        for (const key in css) {
            if (Object.prototype.hasOwnProperty.call(css, key)) {
                const value = css[key];
                this.renderer2.setStyle(this.bigCanvas, key, value);
            }
        }
        this.bigPad = new SignaturePad(this.bigCanvas, fullScreenOptions);
        this.bigPad.onBegin = this._onBegin.bind(this);
        this.bigPad.onEnd = this._onEnd.bind(this);
    }
    initSmallPad() {
        this.smallCanvas = document.querySelector('#nsp-small');
        const { width, height, css } = this.options;
        this.options.width = width ? width : 300;
        this.options.height = height ? height : 150;
        this.smallCanvas.width = this.options.width;
        this.smallCanvas.height = this.options.height;
        for (const key in css) {
            if (Object.prototype.hasOwnProperty.call(css, key)) {
                const value = css[key];
                this.renderer2.setStyle(this.smallCanvas, key, value);
            }
        }
        this.smallPad = new SignaturePad(this.smallCanvas, this.options);
        this.smallPad.onBegin = this._onBegin.bind(this);
        this.smallPad.onEnd = this._onEnd.bind(this);
    }
    _onBegin() {
        this.setDirty(); // When user draws, set state as dirty
        this.beginSign.emit();
    }
    _onEnd() {
        this.signDataHistory = this.toData();
        this.endSign.emit();
    }
    setPadAttribute(key, value) {
        if (this.bigPad) {
            this.bigPad[key] = value;
        }
        this.smallPad[key] = value;
    }
    ngOnInit() {
        this.initSmallPad();
    }
    ngOnChanges(changes) {
        if (changes.options.firstChange) {
            return;
        }
        const { dotSize, minWidth, maxWidth, throttle, minDistance, backgroundColor, penColor, velocityFilterWeight, width, height, css } = changes.options.currentValue;
        if (dotSize) {
            this.setPadAttribute('dotSize', dotSize);
        }
        if (minWidth) {
            this.setPadAttribute('minWidth', minWidth);
        }
        if (maxWidth) {
            this.setPadAttribute('maxWidth', maxWidth);
        }
        if (throttle) {
            this.setPadAttribute('throttle', throttle);
        }
        if (minDistance) {
            this.setPadAttribute('minDistance', minDistance);
        }
        if (backgroundColor) {
            this.setPadAttribute('backgroundColor', backgroundColor);
        }
        if (penColor) {
            this.setPadAttribute('penColor', penColor);
        }
        if (velocityFilterWeight) {
            this.setPadAttribute('velocityFilterWeight', velocityFilterWeight);
        }
        if (width || height) {
            const { width: previousWidth, height: previousHeight } = changes.options.previousValue;
            const data = this.smallPad.toDataURL();
            const image = new Image();
            image.src = data;
            image.onload = () => {
                this.initSmallPad();
                const ctx = this.smallCanvas.getContext('2d');
                ctx.drawImage(image, 0, 0, previousWidth, previousHeight, 0, 0, width, height);
            };
        }
        if (css) {
            if (this.bigCanvas) {
                for (const key in css) {
                    if (Object.prototype.hasOwnProperty.call(css, key)) {
                        const value = css[key];
                        this.renderer2.setStyle(this.bigCanvas, key, value);
                    }
                }
            }
            if (this.smallCanvas) {
                for (const key in css) {
                    if (Object.prototype.hasOwnProperty.call(css, key)) {
                        const value = css[key];
                        this.renderer2.setStyle(this.smallCanvas, key, value);
                    }
                }
            }
        }
    }
}
NgxSignaturePadComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-signature-pad',
                template: "<canvas id=\"nsp-small\"></canvas>\n\n<ng-template #fullScreenTpl>\n  <div class=\"nsp-container\">\n    <div class=\"section left\" style=\"width: 100%;\" [ngStyle]=\"{'height': sectionHeight + 'px'}\"></div>\n    <canvas id=\"nsp-big\"></canvas>\n    <div class=\"section right\" style=\"width: 100%;\" [ngStyle]=\"{'height': sectionHeight + 'px'}\"></div>\n    <ng-content></ng-content>\n  </div>\n</ng-template>",
                styles: [".nsp-container{display:flex;flex-direction:column;position:fixed;left:0;top:0;width:100%;height:100vh;background:#fff}.nsp-container .section{flex:1}.nsp-container .section.left{border-bottom:2px dashed #dedee5}.nsp-container .section.right{border-top:2px dashed #dedee5}"]
            },] }
];
NgxSignaturePadComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: Overlay },
    { type: ViewContainerRef }
];
NgxSignaturePadComponent.propDecorators = {
    options: [{ type: Input }],
    beginSign: [{ type: Output }],
    endSign: [{ type: Output }],
    fullScreenTpl: [{ type: ViewChild, args: ['fullScreenTpl',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXNpZ25hdHVyZS1wYWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9uZ3gtc2lnbmF0dXJlLXBhZC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBS1osU0FBUyxFQUNULGdCQUFnQixFQUNqQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLFlBQTZCLE1BQU0sZUFBZSxDQUFDO0FBRTFELE9BQU8sRUFBRSxPQUFPLEVBQWMsTUFBTSxzQkFBc0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFPckQsTUFBTSxPQUFPLHdCQUF3QjtJQW1ObkMsWUFBb0IsU0FBb0IsRUFBVSxPQUFnQixFQUFVLGdCQUFrQztRQUExRixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUFVLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUF2TTlHLGFBQWE7UUFDTCxvQkFBZSxHQUFrQixFQUFFLENBQUM7UUFHcEMsYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQVFwQixZQUFPLEdBQXdCLEVBQUUsQ0FBQztRQUUxQixjQUFTLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNyQyxZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztJQXVMNkQsQ0FBQztJQTlMbEgsSUFBWSxTQUFTO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6RCxDQUFDO0lBU00sVUFBVTtRQUNmLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxjQUFjLENBQUMsSUFBSSxD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QWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFO3dCQUNsRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO3FCQUNyRDtpQkFDRjthQUNGO1lBQ0QsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO2dCQUNwQixLQUFLLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBRTtvQkFDckIsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFO3dCQUNsRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO3FCQUN2RDtpQkFDRjthQUNGO1NBQ0Y7SUFDSCxDQUFDOzs7WUFwU0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxtQkFBbUI7Z0JBQzdCLDJhQUFpRDs7YUFFbEQ7OztZQXBCQyxTQUFTO1lBYUYsT0FBTztZQUpkLGdCQUFnQjs7O3NCQXFDZixLQUFLO3dCQUVMLE1BQU07c0JBQ04sTUFBTTs0QkFFTixTQUFTLFNBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcG9uZW50LFxyXG4gIFJlbmRlcmVyMixcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIE9uSW5pdCxcclxuICBPbkNoYW5nZXMsXHJcbiAgU2ltcGxlQ2hhbmdlcyxcclxuICBUZW1wbGF0ZVJlZixcclxuICBWaWV3Q2hpbGQsXHJcbiAgVmlld0NvbnRhaW5lclJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgU2lnbmF0dXJlUGFkLCB7IElQb2ludEdyb3VwIH0gZnJvbSAnc2lnbmF0dXJlX3BhZCc7XHJcbmltcG9ydCB7IE5neFNpZ25hdHVyZU9wdGlvbnMgfSBmcm9tICcuL3R5cGVzL25neC1zaWduYXR1cmUtcGFkJztcclxuaW1wb3J0IHsgT3ZlcmxheSwgT3ZlcmxheVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcclxuaW1wb3J0IHsgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbmd4LXNpZ25hdHVyZS1wYWQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9uZ3gtc2lnbmF0dXJlLXBhZC5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vbmd4LXNpZ25hdHVyZS1wYWQuY29tcG9uZW50LnNjc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgTmd4U2lnbmF0dXJlUGFkQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xyXG4gIC8vICNyZWdpb24gVGhlIG9iamVjdCBvZiBkZXBlbmRlbmN5ICdzaWdhbnR1cmVfcGFkJ1xyXG4gIHByaXZhdGUgc21hbGxQYWQ6IFNpZ25hdHVyZVBhZDtcclxuICBwcml2YXRlIGJpZ1BhZDogU2lnbmF0dXJlUGFkO1xyXG4gIC8vICNlbmRyZWdpb25cclxuICAvLyAjcmVnaW9uIFRoZSBvYmplY3Qgb2YgY2FudmFzXHJcbiAgcHJpdmF0ZSBzbWFsbENhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XHJcbiAgcHJpdmF0ZSBiaWdDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xyXG4gIC8vICNlbmRyZWdpb25cclxuICAvLyAjcmVnaW9uIENES1xyXG4gIHByaXZhdGUgb3ZlcmxheVJlZjogT3ZlcmxheVJlZjtcclxuICBwcml2YXRlIHBvcnRhbDogVGVtcGxhdGVQb3J0YWw7XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG4gIHByaXZhdGUgc2lnbkRhdGFIaXN0b3J5OiBJUG9pbnRHcm91cFtdID0gW107XHJcbiAgcHJpdmF0ZSBmdWxsU2NyZWVuV2lkdGg6IG51bWJlcjtcclxuICBwcml2YXRlIGZ1bGxTY3JlZW5IZWlnaHQ6IG51bWJlcjtcclxuICBwcml2YXRlIF9pc0VtcHR5ID0gdHJ1ZTtcclxuICBwcml2YXRlIGlzRnVsbFNjcmVlbiA9IGZhbHNlO1xyXG5cclxuICBwdWJsaWMgc2VjdGlvbkhlaWdodDogbnVtYmVyO1xyXG5cclxuICBwcml2YXRlIGdldCBhY3RpdmVQYWQoKTogU2lnbmF0dXJlUGFkIHtcclxuICAgIHJldHVybiB0aGlzLmlzRnVsbFNjcmVlbiA/IHRoaXMuYmlnUGFkIDogdGhpcy5zbWFsbFBhZDtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgpIG9wdGlvbnM6IE5neFNpZ25hdHVyZU9wdGlvbnMgPSB7fTtcclxuXHJcbiAgQE91dHB1dCgpIHB1YmxpYyBiZWdpblNpZ24gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XHJcbiAgQE91dHB1dCgpIHB1YmxpYyBlbmRTaWduID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xyXG5cclxuICBAVmlld0NoaWxkKCdmdWxsU2NyZWVuVHBsJykgZnVsbFNjcmVlblRwbDogVGVtcGxhdGVSZWY8dm9pZD47XHJcblxyXG4gIHB1YmxpYyBmdWxsU2NyZWVuKCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3J0YWwgPSBuZXcgVGVtcGxhdGVQb3J0YWwodGhpcy5mdWxsU2NyZWVuVHBsLCB0aGlzLnZpZXdDb250YWluZXJSZWYpO1xyXG4gICAgdGhpcy5vdmVybGF5UmVmID0gdGhpcy5vdmVybGF5LmNyZWF0ZSh7XHJcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3k6IHRoaXMub3ZlcmxheS5wb3NpdGlvbigpLmdsb2JhbCgpLFxyXG4gICAgICBzY3JvbGxTdHJhdGVneTogdGhpcy5vdmVybGF5LnNjcm9sbFN0cmF0ZWdpZXMuYmxvY2soKSxcclxuICAgICAgaGVpZ2h0OiAnMTAwJScsXHJcbiAgICAgIHdpZHRoOiAnMTAwJSdcclxuICAgIH0pO1xyXG4gICAgdGhpcy5vdmVybGF5UmVmLmF0dGFjaCh0aGlzLnBvcnRhbCk7XHJcbiAgICB0aGlzLmluaXRCaWdQYWQoKTtcclxuICAgIC8vICNyZWdpb24gQ29weSBtaW5pU2NyZWVuJ3MgY29udGVudCB0byBmdWxsU2NyZWVuXHJcbiAgICBjb25zdCB7IHdpZHRoOiBtaW5pU2NyZWVuV2lkdGgsIGhlaWdodDogbWluaVNjcmVlbkhlaWdodCB9ID0gdGhpcy5vcHRpb25zO1xyXG4gICAgY29uc3QgY3R4ID0gdGhpcy5iaWdDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgIGN0eC5zYXZlKCk7XHJcbiAgICBjdHgudHJhbnNsYXRlKHRoaXMuZnVsbFNjcmVlbldpZHRoLCAwKTtcclxuICAgIGN0eC5yb3RhdGUoKDkwICogTWF0aC5QSSkgLyAxODApO1xyXG4gICAgY3R4LmRyYXdJbWFnZShcclxuICAgICAgdGhpcy5zbWFsbENhbnZhcyxcclxuICAgICAgMCxcclxuICAgICAgMCxcclxuICAgICAgbWluaVNjcmVlbldpZHRoLFxyXG4gICAgICBtaW5pU2NyZWVuSGVpZ2h0LFxyXG4gICAgICAwLFxyXG4gICAgICAwLFxyXG4gICAgICB0aGlzLmZ1bGxTY3JlZW5IZWlnaHQsXHJcbiAgICAgIHRoaXMuZnVsbFNjcmVlbldpZHRoXHJcbiAgICApO1xyXG4gICAgY3R4LnJlc3RvcmUoKTtcclxuICAgIC8vICNlbmRyZWdpb25cclxuICAgIHRoaXMuaXNGdWxsU2NyZWVuID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBtaW5pU2NyZWVuKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zbWFsbFBhZC5jbGVhcigpO1xyXG4gICAgLy8gI3JlZ2lvbiBDb3B5IGZ1bGxTY3JlZW4ncyBjb250ZW50IHRvIG1pbmlTY3JlZW5cclxuICAgIGNvbnN0IHsgd2lkdGg6IG1pbmlTY3JlZW5XaWR0aCwgaGVpZ2h0OiBtaW5pU2NyZWVuSGVpZ2h0IH0gPSB0aGlzLm9wdGlvbnM7XHJcbiAgICBjb25zdCB3aWR0aFNjYWxlID0gbWluaVNjcmVlbldpZHRoIC8gdGhpcy5mdWxsU2NyZWVuSGVpZ2h0O1xyXG4gICAgY29uc3QgaGVpZ2h0U2NhbGUgPSBtaW5pU2NyZWVuSGVpZ2h0IC8gdGhpcy5mdWxsU2NyZWVuV2lkdGg7XHJcbiAgICBjb25zdCBjdHggPSB0aGlzLnNtYWxsQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcbiAgICBjdHguc2F2ZSgpO1xyXG4gICAgY3R4LnRyYW5zbGF0ZSgwLCBtaW5pU2NyZWVuSGVpZ2h0KTtcclxuICAgIGN0eC5yb3RhdGUoKC05MCAqIE1hdGguUEkpIC8gMTgwKTtcclxuICAgIGN0eC5kcmF3SW1hZ2UoXHJcbiAgICAgIHRoaXMuYmlnQ2FudmFzLFxyXG4gICAgICAwLFxyXG4gICAgICAwLFxyXG4gICAgICB0aGlzLmZ1bGxTY3JlZW5XaWR0aCxcclxuICAgICAgdGhpcy5mdWxsU2NyZWVuSGVpZ2h0LFxyXG4gICAgICAwLFxyXG4gICAgICAwLFxyXG4gICAgICB0aGlzLmZ1bGxTY3JlZW5XaWR0aCAqIHdpZHRoU2NhbGUsXHJcbiAgICAgIHRoaXMuZnVsbFNjcmVlbkhlaWdodCAqIGhlaWdodFNjYWxlXHJcbiAgICApO1xyXG4gICAgY3R4LnJlc3RvcmUoKTtcclxuICAgIC8vICNlbmRyZWdpb25cclxuICAgIHRoaXMub3ZlcmxheVJlZi5kaXNwb3NlKCk7XHJcbiAgICB0aGlzLmJpZ0NhbnZhcyA9IG51bGw7XHJcbiAgICB0aGlzLmJpZ1BhZCA9IG51bGw7XHJcbiAgICB0aGlzLmlzRnVsbFNjcmVlbiA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqIFJldHVybnMgc2lnbmF0dXJlIGltYWdlIGFzIGFuIGFycmF5IG9mIHBvaW50IGdyb3VwcyAqL1xyXG4gIHB1YmxpYyB0b0RhdGEoKTogSVBvaW50R3JvdXBbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5hY3RpdmVQYWQudG9EYXRhKCk7XHJcbiAgfVxyXG5cclxuICAvKiogRHJhd3Mgc2lnbmF0dXJlIGltYWdlIGZyb20gYW4gYXJyYXkgb2YgcG9pbnQgZ3JvdXBzICovXHJcbiAgcHVibGljIGZyb21EYXRhKHBvaW50R3JvdXBzOiBJUG9pbnRHcm91cFtdKTogdm9pZCB7XHJcbiAgICB0aGlzLmFjdGl2ZVBhZC5mcm9tRGF0YShwb2ludEdyb3Vwcyk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgdG9EYXRhVVJMKHR5cGU/OiAnaW1hZ2UvanBlZycgfCAnaW1hZ2Uvc3ZnK3htbCcpOiBzdHJpbmcge1xyXG4gICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgIGNhc2UgJ2ltYWdlL2pwZWcnOlxyXG4gICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZVBhZC50b0RhdGFVUkwoJ2ltYWdlL2pwZWcnKTtcclxuICAgICAgY2FzZSAnaW1hZ2Uvc3ZnK3htbCc6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlUGFkLnRvRGF0YVVSTCgnaW1hZ2Uvc3ZnK3htbCcpO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZVBhZC50b0RhdGFVUkwoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXZlcnQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnNpZ25EYXRhSGlzdG9yeS5wb3AoKTtcclxuICAgIHRoaXMuZnJvbURhdGEodGhpcy5zaWduRGF0YUhpc3RvcnkpO1xyXG4gICAgaWYgKHRoaXMuc2lnbkRhdGFIaXN0b3J5Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aGlzLnNldEVtcHR5KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBDbGVhcnMgdGhlIGNhbnZhc1xyXG4gIHB1YmxpYyBjbGVhcigpOiB2b2lkIHtcclxuICAgIHRoaXMuc2V0RW1wdHkoKTtcclxuICAgIHRoaXMuc2lnbkRhdGFIaXN0b3J5ID0gW107XHJcbiAgICB0aGlzLmFjdGl2ZVBhZC5jbGVhcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqIFJldHVybiB0cnVlIGlmIGNhbnZhcyBpcyBlbXB0eSwgb3RoZXJ3aXNlIHJldHVybiBmYWxzZSAqL1xyXG4gIHB1YmxpYyBpc0VtcHR5KCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lzRW1wdHk7XHJcbiAgfVxyXG5cclxuICAvKiogU2V0IGNhbnZhcydzIHN0YXRlIGFzIGRpcnR5ICovXHJcbiAgcHVibGljIHNldERpcnR5KCk6IHZvaWQge1xyXG4gICAgdGhpcy5faXNFbXB0eSA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqIFNldCBjYW52YXMncyBzdGF0ZSBhcyBlbXB0eSAqL1xyXG4gIHB1YmxpYyBzZXRFbXB0eSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2lzRW1wdHkgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldENvbnRleHQoKTogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEIHtcclxuICAgIHJldHVybiB0aGlzLmlzRnVsbFNjcmVlbiA/IHRoaXMuYmlnQ2FudmFzLmdldENvbnRleHQoJzJkJykgOiB0aGlzLnNtYWxsQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRCaWdQYWQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmJpZ0NhbnZhcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNuc3AtYmlnJyk7XHJcbiAgICBjb25zdCBmdWxsU2NyZWVuT3B0aW9ucyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5vcHRpb25zKSk7XHJcbiAgICAvLyBDYWxjdWxhdGUgdGhlIGZ1bGxTY3JlZW4gcGFkJ3Mgc2l6ZVxyXG4gICAgdGhpcy5mdWxsU2NyZWVuV2lkdGggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7XHJcbiAgICBjb25zdCB7IHdpZHRoOiBtaW5pU2NyZWVuV2lkdGgsIGhlaWdodDogbWluaVNjcmVlbkhlaWdodCB9ID0gdGhpcy5vcHRpb25zO1xyXG4gICAgdGhpcy5mdWxsU2NyZWVuSGVpZ2h0ID0gKHRoaXMuZnVsbFNjcmVlbldpZHRoICogbWluaVNjcmVlbldpZHRoKSAvIG1pbmlTY3JlZW5IZWlnaHQ7XHJcbiAgICAvLyBDYWxjdWxhdGUgc2VjdGlvbiBzaXplXHJcbiAgICBjb25zdCB2aWV3SGVpZ2h0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDtcclxuICAgIGNvbnN0IHNwYWNlID0gdmlld0hlaWdodCAtIHRoaXMuZnVsbFNjcmVlbkhlaWdodDtcclxuICAgIHRoaXMuc2VjdGlvbkhlaWdodCA9IHNwYWNlIC8gMjtcclxuICAgIC8vIEluaXQgcGFkXHJcbiAgICBmdWxsU2NyZWVuT3B0aW9ucy53aWR0aCA9IHRoaXMuZnVsbFNjcmVlbldpZHRoO1xyXG4gICAgZnVsbFNjcmVlbk9wdGlvbnMuaGVpZ2h0ID0gdGhpcy5mdWxsU2NyZWVuSGVpZ2h0O1xyXG4gICAgY29uc3QgeyBjc3MgfSA9IGZ1bGxTY3JlZW5PcHRpb25zO1xyXG4gICAgdGhpcy5iaWdDYW52YXMud2lkdGggPSB0aGlzLmZ1bGxTY3JlZW5XaWR0aDtcclxuICAgIHRoaXMuYmlnQ2FudmFzLmhlaWdodCA9IHRoaXMuZnVsbFNjcmVlbkhlaWdodDtcclxuICAgIGZvciAoY29uc3Qga2V5IGluIGNzcykge1xyXG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGNzcywga2V5KSkge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gY3NzW2tleV07XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlcjIuc2V0U3R5bGUodGhpcy5iaWdDYW52YXMsIGtleSwgdmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLmJpZ1BhZCA9IG5ldyBTaWduYXR1cmVQYWQodGhpcy5iaWdDYW52YXMsIGZ1bGxTY3JlZW5PcHRpb25zKTtcclxuICAgIHRoaXMuYmlnUGFkLm9uQmVnaW4gPSB0aGlzLl9vbkJlZ2luLmJpbmQodGhpcyk7XHJcbiAgICB0aGlzLmJpZ1BhZC5vbkVuZCA9IHRoaXMuX29uRW5kLmJpbmQodGhpcyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRTbWFsbFBhZCgpOiB2b2lkIHtcclxuICAgIHRoaXMuc21hbGxDYW52YXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjbnNwLXNtYWxsJyk7XHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGNzcyB9ID0gdGhpcy5vcHRpb25zO1xyXG4gICAgdGhpcy5vcHRpb25zLndpZHRoID0gd2lkdGggPyB3aWR0aCA6IDMwMDtcclxuICAgIHRoaXMub3B0aW9ucy5oZWlnaHQgPSBoZWlnaHQgPyBoZWlnaHQgOiAxNTA7XHJcbiAgICB0aGlzLnNtYWxsQ2FudmFzLndpZHRoID0gdGhpcy5vcHRpb25zLndpZHRoO1xyXG4gICAgdGhpcy5zbWFsbENhbnZhcy5oZWlnaHQgPSB0aGlzLm9wdGlvbnMuaGVpZ2h0O1xyXG4gICAgZm9yIChjb25zdCBrZXkgaW4gY3NzKSB7XHJcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoY3NzLCBrZXkpKSB7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBjc3Nba2V5XTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyMi5zZXRTdHlsZSh0aGlzLnNtYWxsQ2FudmFzLCBrZXksIHZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5zbWFsbFBhZCA9IG5ldyBTaWduYXR1cmVQYWQodGhpcy5zbWFsbENhbnZhcywgdGhpcy5vcHRpb25zKTtcclxuICAgIHRoaXMuc21hbGxQYWQub25CZWdpbiA9IHRoaXMuX29uQmVnaW4uYmluZCh0aGlzKTtcclxuICAgIHRoaXMuc21hbGxQYWQub25FbmQgPSB0aGlzLl9vbkVuZC5iaW5kKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfb25CZWdpbigpOiB2b2lkIHtcclxuICAgIHRoaXMuc2V0RGlydHkoKTsgLy8gV2hlbiB1c2VyIGRyYXdzLCBzZXQgc3RhdGUgYXMgZGlydHlcclxuICAgIHRoaXMuYmVnaW5TaWduLmVtaXQoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX29uRW5kKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zaWduRGF0YUhpc3RvcnkgPSB0aGlzLnRvRGF0YSgpO1xyXG4gICAgdGhpcy5lbmRTaWduLmVtaXQoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0UGFkQXR0cmlidXRlKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5iaWdQYWQpIHtcclxuICAgICAgdGhpcy5iaWdQYWRba2V5XSA9IHZhbHVlO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zbWFsbFBhZFtrZXldID0gdmFsdWU7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyMjogUmVuZGVyZXIyLCBwcml2YXRlIG92ZXJsYXk6IE92ZXJsYXksIHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZikge31cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmluaXRTbWFsbFBhZCgpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgaWYgKGNoYW5nZXMub3B0aW9ucy5maXJzdENoYW5nZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7XHJcbiAgICAgIGRvdFNpemUsXHJcbiAgICAgIG1pbldpZHRoLFxyXG4gICAgICBtYXhXaWR0aCxcclxuICAgICAgdGhyb3R0bGUsXHJcbiAgICAgIG1pbkRpc3RhbmNlLFxyXG4gICAgICBiYWNrZ3JvdW5kQ29sb3IsXHJcbiAgICAgIHBlbkNvbG9yLFxyXG4gICAgICB2ZWxvY2l0eUZpbHRlcldlaWdodCxcclxuICAgICAgd2lkdGgsXHJcbiAgICAgIGhlaWdodCxcclxuICAgICAgY3NzXHJcbiAgICB9ID0gY2hhbmdlcy5vcHRpb25zLmN1cnJlbnRWYWx1ZTtcclxuICAgIGlmIChkb3RTaXplKSB7XHJcbiAgICAgIHRoaXMuc2V0UGFkQXR0cmlidXRlKCdkb3RTaXplJywgZG90U2l6ZSk7XHJcbiAgICB9XHJcbiAgICBpZiAobWluV2lkdGgpIHtcclxuICAgICAgdGhpcy5zZXRQYWRBdHRyaWJ1dGUoJ21pbldpZHRoJywgbWluV2lkdGgpO1xyXG4gICAgfVxyXG4gICAgaWYgKG1heFdpZHRoKSB7XHJcbiAgICAgIHRoaXMuc2V0UGFkQXR0cmlidXRlKCdtYXhXaWR0aCcsIG1heFdpZHRoKTtcclxuICAgIH1cclxuICAgIGlmICh0aHJvdHRsZSkge1xyXG4gICAgICB0aGlzLnNldFBhZEF0dHJpYnV0ZSgndGhyb3R0bGUnLCB0aHJvdHRsZSk7XHJcbiAgICB9XHJcbiAgICBpZiAobWluRGlzdGFuY2UpIHtcclxuICAgICAgdGhpcy5zZXRQYWRBdHRyaWJ1dGUoJ21pbkRpc3RhbmNlJywgbWluRGlzdGFuY2UpO1xyXG4gICAgfVxyXG4gICAgaWYgKGJhY2tncm91bmRDb2xvcikge1xyXG4gICAgICB0aGlzLnNldFBhZEF0dHJpYnV0ZSgnYmFja2dyb3VuZENvbG9yJywgYmFja2dyb3VuZENvbG9yKTtcclxuICAgIH1cclxuICAgIGlmIChwZW5Db2xvcikge1xyXG4gICAgICB0aGlzLnNldFBhZEF0dHJpYnV0ZSgncGVuQ29sb3InLCBwZW5Db2xvcik7XHJcbiAgICB9XHJcbiAgICBpZiAodmVsb2NpdHlGaWx0ZXJXZWlnaHQpIHtcclxuICAgICAgdGhpcy5zZXRQYWRBdHRyaWJ1dGUoJ3ZlbG9jaXR5RmlsdGVyV2VpZ2h0JywgdmVsb2NpdHlGaWx0ZXJXZWlnaHQpO1xyXG4gICAgfVxyXG4gICAgaWYgKHdpZHRoIHx8IGhlaWdodCkge1xyXG4gICAgICBjb25zdCB7IHdpZHRoOiBwcmV2aW91c1dpZHRoLCBoZWlnaHQ6IHByZXZpb3VzSGVpZ2h0IH0gPSBjaGFuZ2VzLm9wdGlvbnMucHJldmlvdXNWYWx1ZTtcclxuICAgICAgY29uc3QgZGF0YSA9IHRoaXMuc21hbGxQYWQudG9EYXRhVVJMKCk7XHJcbiAgICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7XHJcbiAgICAgIGltYWdlLnNyYyA9IGRhdGE7XHJcbiAgICAgIGltYWdlLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmluaXRTbWFsbFBhZCgpO1xyXG4gICAgICAgIGNvbnN0IGN0eCA9IHRoaXMuc21hbGxDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCAwLCAwLCBwcmV2aW91c1dpZHRoLCBwcmV2aW91c0hlaWdodCwgMCwgMCwgd2lkdGgsIGhlaWdodCk7XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBpZiAoY3NzKSB7XHJcbiAgICAgIGlmICh0aGlzLmJpZ0NhbnZhcykge1xyXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIGNzcykge1xyXG4gICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjc3MsIGtleSkpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBjc3Nba2V5XTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlcjIuc2V0U3R5bGUodGhpcy5iaWdDYW52YXMsIGtleSwgdmFsdWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5zbWFsbENhbnZhcykge1xyXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIGNzcykge1xyXG4gICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjc3MsIGtleSkpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBjc3Nba2V5XTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlcjIuc2V0U3R5bGUodGhpcy5zbWFsbENhbnZhcywga2V5LCB2YWx1ZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==